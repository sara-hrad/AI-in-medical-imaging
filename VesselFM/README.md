# Vessel Segmentation using VesselFM for Pulmonary Embolism Detection

This document outlines the process of using [VesselFM](https://github.com/bwittmann/vesselFM) to segment blood vessels in chest CT scans. This is a crucial step in our project, "Detection of Pulmonary Embolism using Google CT Foundation Model," as it helps focus the foundation model on the relevant vascular structures.

## Overview

The workflow involves the following key steps:
1.  **Installation of VesselFM:** Setting up the necessary environment and dependencies.
2.  **Data Preparation:** Converting DICOM CT scans to the NIfTI format (`.nii.gz`) required by VesselFM.
3.  **Vessel Segmentation:** Running VesselFM's zero-shot inference script to segment the vessels.
4.  **Format Conversion:** Converting the segmented NIfTI masks back to DICOM series for input into the CT foundation model.

## Step 1: Install VesselFM

Follow these instructions to set up a conda environment and install VesselFM along with its dependencies.

```bash
# Create a new conda environment
conda create -n vesselfm python=3.9

# Activate the environment
conda activate vesselfm

# Clone the VesselFM repository (if you haven't already)
# git clone [https://github.com/bwittmann/vesselFM.git](https://github.com/bwittmann/vesselFM.git)
# cd vesselFM

# Install VesselFM and its dependencies
pip install -e .
```
## Note on Installation

Ensure you are in the root directory of the cloned VesselFM repository when running `pip install -e .`. For full installation instructions, please refer to the main project README.

## Step 2: Prepare Data (DICOM to NIfTI)

VesselFM requires input data to be in the NIfTI (`.nii.gz`) format. Since our original CT scans are in DICOM format, we need to convert them.

1.  Place your dataset of CT studies (each study typically in its own folder containing DICOM files) into a directory named `dicom_original`.
2.  Use the provided `dicom_2_nifti.py` script to perform the conversion.

    ```bash
    python dicom_2_nifti.py
    ```
    This script will process the DICOM files from `dicom_original` and save the resulting NIfTI files (e.g., `studyID.nii.gz`) into a directory named `input_nifti`.

## Step 3: Run VesselFM for Zero-Shot Segmentation

We will utilize VesselFM's zero-shot segmentation capabilities. This requires modifying the inference configuration file and then running the inference script.

1.  **Replace Configuration File:**
    * Locate the `inference.yaml` file provided in this project.
    * Replace the existing `inference.yaml` file within the VesselFM directory at `vesselFM/seg/configs/inference.yaml` with the one from this project. This custom configuration is tailored for our specific needs.

2.  **Run Inference:**
    Execute the inference script from the root directory of your VesselFM installation.

    ```bash
    python vesselfm/seg/inference.py
    ```
    The script will use the settings defined in the modified `inference.yaml` to process the NIfTI files located in the `input_nifti` directory (or as specified in your `inference.yaml` if you further customized it). The segmented output masks (also in NIfTI format) will be saved to the output directory specified in the `inference.yaml` file.

## Step 4: Convert Segmented Masks (NIfTI to DICOM)

The Google CT foundation model requires input in DICOM format. Therefore, we need to convert the NIfTI segmentation masks generated by VesselFM back into DICOM series.

1.  Ensure your segmented NIfTI files (the output from Step 3) are accessible.
2.  Use the provided `nifti_2_dicom.py` script for this conversion. This script will likely require the original DICOM series as a reference for metadata.

    ```bash
    python nifti_2_dicom.py
    ```
    This script will take the NIfTI masks and the original DICOM series to create new DICOM series where the segmentation is applied. The exact input and output paths might need to be adjusted within the `nifti_2_dicom.py` script or passed as arguments, depending on its implementation.

## Directory Structure (Example)

```
AI-in-medical-imaging/VesselFM
├── dicom_original/               # Input: Original DICOM studies
│   ├── Study1/
│   │   ├── image1.dcm
│   │   └── ...
│   └── Study2/
│       └── ...
├── input_nifti/                  # Output of dicom_2_nifti.py, Input for VesselFM
│   ├── Study1.nii.gz
│   └── Study2.nii.gz
├── vesselFM/                     # Cloned VesselFM repository
│   ├── seg/
│   │   ├── configs/
│   │   │   └── inference.yaml    # Replaced with our custom config
│   │   └── inference.py
│   └── ...
├── output_nifti/        # Output of VesselFM (example path, configure in inference.yaml)
│   ├── Study1_mask.nii.gz
│   └── Study2_mask.nii.gz
├── output_dicom/       # Output of nifti_2_dicom.py, Input for Foundation Model
│   ├── Study1_segmented/
│   │   ├── image1.dcm
│   │   └── ...
│   └── Study2_segmented/
│       └── ...
├── dicom_2_nifti.py
├── nifti_2_dicom.py
├── inference.yaml                # Our custom inference configuration for VesselFM
├── requirement.txt               # The required package for this project
└── README.md                     # Main project README file
```